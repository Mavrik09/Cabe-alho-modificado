<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Extrator de Cabe√ßalhos PJe</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<style>
        :root {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --input-bg-color: #ffffff;
            --input-border-color: #cbd5e1;
            --primary-color: #3b82f6;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --card-bg: #ffffff;
            --card-border: #e2e8f0;
            --tab-bg: #e2e8f0;
            --tab-active-bg: #ffffff;
            --tab-active-text: #0f172a;
            --tab-inactive-text: #64748b;
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        body.dark {
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --input-bg-color: #1e293b;
            --input-border-color: #334155;
            --primary-color: #60a5fa;
            --secondary-color: #34d399;
            --danger-color: #f87171;
            --card-bg: #1e293b;
            --card-border: #334155;
            --tab-bg: #1e293b;
            --tab-active-bg: #334155;
            --tab-active-text: #f8fafc;
            --tab-inactive-text: #94a3b8;
            --shadow-md: 0 2px 8px rgba(255, 255, 255, 0.05);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Inter', system-ui, sans-serif;
        }

        /* üîπ Garante que todos os elementos copiados mantenham o espa√ßamento 1,5 */
        div,
        p,
        td,
        table,
        span,
        strong {
            line-height: 18pt !important;
            mso-line-height-alt:18pt;
        }

        /* --- ALERTA --- */
        #alert-box {
            display: none;
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 1050;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            background-color: var(--secondary-color);
            color: #fff;
            box-shadow: var(--shadow-md);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- TEXTAREAS --- */
        #extrator-view textarea {
            width: 100%;
            height: 120px;
            margin-bottom: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border: 1px solid var(--input-border-color);
            border-radius: var(--radius);
            padding: 12px;
            box-shadow: var(--shadow-md);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #extrator-view textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        /* --- BOT√ïES --- */
        .botao {
            border: none;
            color: #fff;
            padding: 10px 22px;
            font-weight: 600;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-md);
        }

        .botao:hover {
            transform: translateY(-2px);
            opacity: 0.95;
        }

        #extrairTextoCopiado {
            background-color: var(--secondary-color);
        }

        #limparCaixas {
            background-color: var(--danger-color);
        }

        #copiarDados {
            background-color: var(--primary-color);
        }

        #gerarWord {
            background-color: #64748b;
        }

        /* --- TABELA --- */
        .tabela-dados-pje {
            width: 100%;
            max-width: 850px;
            border-collapse: collapse;
            margin-top: 24px;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        /* Ajuste: Remove o padding do TD para que o editor Quill controle o espa√ßamento */
        .tabela-dados-pje td {
            border: 1px solid var(--card-border);
            padding: 0;
            /* O editor Quill agora controlar√° o padding */
        }

        /* --- OUTPUT EDITOR STYLING --- */
        #dados-para-copiar .ql-toolbar {
            border: 1px solid var(--input-border-color);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-top: 5px;
        }

        #dados-para-copiar .ql-container {
            border: 1px solid var(--input-border-color);
            border-radius: 0 0 8px 8px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
        }

        /* Dist√¢ncia sutil e garantia da formata√ß√£o Arial 12pt */
        #dados-para-copiar .ql-editor {
            min-height: 100px;
            padding: 10px 15px;
            /* Dist√¢ncia sutil da borda */
            font-family: Arial, sans-serif !important;
            font-size: 12pt !important;
            line-height: 18pt !important;
            mso-line-height-alt:18pt;
        }

        /* Ajuste no padding do TD para o cabe√ßalho e t√≠tulos */
        .tabela-dados-pje td>p {
            padding: 12px 16px 0 16px;
            /* Padding no topo do titulo */
        }

        .tabela-dados-pje td>div:first-of-type {
            padding: 0 16px 12px 16px;
            /* Padding na base se for o div do titulo */
        }

        .titulo-tabela {
            text-align: center;
            font-weight: 700;
        }

        .titulo-principal {
            text-decoration: underline;
        }

        /* --- ABAS --- */
        .tab-button {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            border-radius: 10px 10px 0 0;
            background-color: var(--tab-bg);
            color: var(--tab-inactive-text);
            border: 1px solid transparent;
            border-bottom: none;
            transition: all 0.2s ease;
        }

        .tab-button.active {
            background-color: var(--tab-active-bg);
            color: var(--tab-active-text);
            border-color: var(--card-border);
            box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.05);
        }

        /* --- CL√ÅUSULAS --- */
        #clausulas-list,
        #clausula-viewer {
            height: calc(100vh - 250px);
            overflow-y: auto;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 12px;
            box-shadow: var(--shadow-md);
        }

        .clausula-item {
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 6px;
            transition: all 0.2s ease;
        }

        .clausula-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .clausula-item.selected {
            background-color: var(--primary-color);
            color: #fff !important;
        }

        /* --- EDITOR DE CL√ÅUSULAS --- */
        #clause-editor-container {
            height: 260px;
            margin-top: 1rem;
        }

        .ql-toolbar {
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .ql-container {
            border-radius: 0 0 0.75rem 0.75rem;
            font-size: 1rem;
        }

        body.dark .ql-snow .ql-stroke,
        body.dark .ql-snow .ql-fill,
        body.dark .ql-snow .ql-picker-label {
            stroke: var(--text-color);
            color: var(--text-color);
        }

        /* --- MODAL --- */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="p-4 md:p-8">
<header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
<div>
<h1 class="text-3xl font-bold">Extrator de Cabe√ßalhos PJe</h1>
<p class="text-sm text-gray-500 dark:text-gray-400">Extrator de Cabe√ßalhos e Gestor de Cl√°usulas</p>
</div>
<div class="fixed top-4 right-4 z-50 text-center flex items-center gap-4">
<div class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block" id="Autor">
                Filipe S. Lima | Gabriel F. Angst<br/>e-CEJUSC 3/TJDFT | 13/10/25 13:55 <br/><a href="https://tjdf.sharepoint.com/sites/eCEJUSC3/_layouts/15/stream.aspx?id=%2Fsites%2FeCEJUSC3%2FPasta%20de%20rede%2F04%20V%C3%ADdeos%20Instrut%C3%B3rios%2F07%2E%20Ferramentas%20Adicionais%2F01%20-%20Extrator%20PJe%2Emp4" target="_blank">‚ùì Como utilizar? </a>
</div>
<label>
<input class="hidden" id="theme-toggle" type="checkbox"/>
<span class="cursor-pointer p-3 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center" id="theme-label">
<i class="fas fa-moon" id="theme-icon"></i>
</span>
</label>
</div>
</header>
<div class="mb-4 border-b border-gray-200 dark:border-gray-700">
<nav aria-label="Tabs" class="flex -mb-px">
<button class="tab-button active" id="tab-extrator" onclick="showTab('extrator')">
                Extrator de Cabe√ßalhos
            </button>
<button class="tab-button" id="tab-clausulas" onclick="showTab('clausulas')">
                Cl√°usulas Minutadas
            </button>
</nav>
</div>
<main>
<div id="extrator-view">
<textarea id="caixa1" placeholder="Ap√≥s abrir o cabe√ßalho do processo no PJe e copiar todos os dados apertando Ctrl+A e Ctrl+C, cole aqui ou clique no bot√£o 'Extrair texto copiado'"></textarea>
<textarea class="hidden" id="caixa2"></textarea>
<textarea class="hidden" id="caixa3"></textarea>
<textarea class="hidden" id="caixa4"></textarea>
<textarea class="hidden" id="caixa5"></textarea>
<textarea class="hidden" id="caixa6"></textarea>
<textarea class="hidden" id="caixa7"></textarea>
<div class="flex flex-wrap gap-2 mb-6">
<button class="botao" id="extrairTextoCopiado" onclick="extrairClipboard()">Extrair texto
                    copiado</button>
<button class="botao" id="limparCaixas" onclick="limparCaixas()">Limpar Caixas</button>
<button class="botao" id="copiarDados" onclick="copiarDadosFormatados()">Copiar Cabe√ßalho</button>
<button class="botao" hidden="" id="gerarWord" onclick="gerarWord()">Baixar Word (opcional)</button>
</div>
<div class="space-y-6" id="dados-para-copiar">
<table class="tabela-dados-pje">
<tbody>
<tr>
<td>
<p class="titulo-tabela"><span class="titulo-principal">DADOS EXTRA√çDOS DO PJE</span>
</p>
<div id="output1"></div>
</td>
</tr>
</tbody>
</table>
<table class="tabela-dados-pje">
<tbody>
<tr>
<td>
<p class="titulo-tabela"><span class="titulo-principal">PARTICIPANTES DA
                                        AUDI√äNCIA</span></p>
<div id="output2"></div>
</td>
</tr>
</tbody>
</table>
<table class="tabela-dados-pje">
<tbody>
<tr>
<td>
<p class="titulo-tabela">
<span class="titulo-principal">DADOS DAS PARTES</span><br/>
<span class="subtitulo-tabela text-xs">(Portaria Conjunta GPR, GPVP, GSVP e GC n.¬∫
                                        71/2013; e CPC, art. 319, II)</span>
</p>
<div id="output3"></div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="hidden" id="clausulas-view">
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
<div class="md:col-span-1 flex flex-col gap-4">
<div class="relative">
<input class="w-full p-3 rounded-lg border bg-[var(--input-bg-color)] border-[var(--input-border-color)] pl-10" id="search-clausulas" placeholder="Buscar cl√°usula..." type="text"/>
<i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
</div>
<div class="bg-[var(--card-bg)] border border-[var(--card-border)] rounded-lg p-2 space-y-1" id="clausulas-list">
</div>
<button class="w-full p-3 text-white font-bold rounded-lg bg-[var(--secondary-color)] hover:opacity-90 transition-opacity" id="incluir-clausula-btn">
<i class="fas fa-plus-circle mr-2"></i>Incluir / Gerenciar
                    </button>
</div>
<div class="md:col-span-2 bg-[var(--card-bg)] border border-[var(--card-border)] rounded-lg p-6">
<div id="clausula-viewer">
<div class="text-center text-gray-500 dark:text-gray-400">
<i class="fas fa-file-alt fa-3x mb-4"></i>
<p class="font-semibold">Selecione uma cl√°usula √† esquerda para visualizar seu conte√∫do
                                aqui.</p>
</div>
</div>
</div>
</div>
</div>
</main>
<div id="alert-box"></div>
<div class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" id="password-modal">
<div class="bg-[var(--card-bg)] rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
<h3 class="text-xl font-semibold mb-4">Acesso Restrito</h3>
<p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Insira a senha para gerenciar as cl√°usulas.</p>
<input class="w-full p-2 border border-[var(--input-border-color)] rounded-md bg-[var(--input-bg-color)]" id="password-input" placeholder="Senha" type="password"/>
<p class="text-red-500 text-sm mt-2 hidden" id="password-error">Senha incorreta.</p>
<div class="flex justify-end gap-3 mt-6">
<button class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:opacity-80" onclick="closeModal('password-modal')">Cancelar</button>
<button class="px-4 py-2 bg-[var(--primary-color)] text-white rounded-md hover:opacity-80 font-semibold" onclick="checkPassword()">Confirmar</button>
</div>
</div>
</div>
<div class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" id="manage-clause-modal">
<div class="bg-[var(--card-bg)] rounded-lg shadow-2xl p-8 w-full max-w-4xl m-4 flex flex-col gap-6 max-h-[90vh]">
<h3 class="text-2xl font-semibold">Gerenciar Cl√°usulas</h3>
<form class="flex flex-col gap-4" id="clause-form">
<input id="clause-id" type="hidden"/>
<input class="w-full p-3 border border-[var(--input-border-color)] rounded-md bg-[var(--input-bg-color)]" id="clause-title" placeholder="T√≠tulo da Cl√°usula" required="" type="text"/>
<div id="clause-editor-container"></div>
<div class="flex justify-end gap-3">
<button class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:opacity-80" onclick="resetClauseForm()" type="button">Novo</button>
<button class="px-4 py-2 bg-[var(--primary-color)] text-white rounded-md hover:opacity-80 font-semibold" type="submit">Salvar
                        Cl√°usula</button>
</div>
</form>
<div class="border-t border-[var(--card-border)] pt-4 flex-grow overflow-y-auto">
<h4 class="font-semibold mb-2">Cl√°usulas Existentes</h4>
<div class="space-y-2" id="manage-clausulas-list">
</div>
</div>
<div class="flex justify-end pt-4 border-t border-[var(--card-border)]">
<button class="px-6 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:opacity-80" onclick="closeModal('manage-clause-modal')" type="button">Fechar</button>
</div>
</div>
</div>
<div class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" id="edit-before-copy-modal">
<div class="bg-[var(--card-bg)] rounded-lg shadow-2xl p-6 w-full max-w-4xl m-4 flex flex-col gap-4 max-h-[90vh] overflow-auto">
<h3 class="text-2xl font-semibold">Editar Cabe√ßalho + Cl√°usula</h3>
<div id="edit-copy-container" style="height: 400px;"></div>
<div class="flex justify-end gap-3">
<button class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:opacity-80" onclick="closeModal('edit-before-copy-modal')" type="button">Cancelar</button>
<button class="ml-2 px-4 py-2 bg-[var(--secondary-color)] text-white rounded-md hover:opacity-80 font-semibold" onclick="copiarSomenteTextoEditado()" type="button">
                    Copiar apenas texto (sem cabe√ßalho)
                </button>
<button class="px-4 py-2 bg-[var(--primary-color)] text-white rounded-md hover:opacity-80 font-semibold" onclick="copiarTextoEditado()" type="button">
                    Copiar texto com cabe√ßalho
                </button>
</div>
</div>
</div>
<script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyB4Wx4yJq4xjU4Y0-DWJc2H7aWeBFQg7xk",
            authDomain: "extrator-clausulas.firebaseapp.com",
            databaseURL: "https://extrator-clausulas-default-rtdb.firebaseio.com",
            projectId: "extrator-clausulas",
            storageBucket: "extrator-clausulas.appspot.com",
            messagingSenderId: "530836265351",
            appId: "1:530836265351:web:97bfb9901b4c8d77989b22",
            measurementId: "G-P710G5CVT5"
        };

        // Inicializa√ß√£o do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const clausesRef = ref(db, 'clauses');
        let allClauses = {};
        let quill = null;
        let quillEditCopy = null;

        // --- EDITORES DE OUTPUT ---
        let quillOutput1 = null;
        let quillOutput2 = null;
        let quillOutput3 = null;

        const outputToolbar = [
            [{ 'font': [] }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'align': [] }],
            ['clean']
        ];

        // ===================================================================
        // FUN√á√ÉO PARA PRESERVAR A FORMATA√á√ÉO VISUAL DO EDITOR
        // ===================================================================
        const getFormattedContentFromQuill = (quillInstance) => {
            if (!quillInstance) return '';
            
            let htmlContent = quillInstance.root.innerHTML;
            
            // Preserva as quebras de linha visuais
            htmlContent = htmlContent.replace(/<p><br><\/p>/g, '<br>');
            
            // Aplica espa√ßamento entre linhas de 1.5 em todos os par√°grafos
            htmlContent = htmlContent.replace(/<p\b[^>]*>/g, '<p style="margin: 0; line-height: 18pt; mso-line-height-alt:18pt;">');
            
            return htmlContent;
        };

        function initializeOutputEditors() {
            if (quillOutput1) return;

            const editorConfig = {
                theme: 'snow',
                modules: { 
                    toolbar: outputToolbar,
                    clipboard: {
                        matchVisual: true
                    }
                },
                formats: ['font', 'size', 'bold', 'italic', 'underline', 'strike', 'color', 'background', 'list', 'align']
            };

            quillOutput1 = new Quill('#output1', editorConfig);
            quillOutput2 = new Quill('#output2', editorConfig);
            quillOutput3 = new Quill('#output3', editorConfig);

            [quillOutput1, quillOutput2, quillOutput3].forEach(q => {
                const Font = Quill.import('formats/font');
                Font.whitelist = ['arial', 'serif', 'sans-serif'];
                Quill.register(Font, true);

                q.root.style.fontFamily = 'Arial, sans-serif';
                q.root.style.fontSize = '12pt';
                q.root.style.lineHeight = '18pt';
                
                q.format('font', 'arial');
                q.format('size', '12pt');
            });
        }

        // --- L√ìGICA GERAL E DE ABAS ---
        function initializeQuillEditor() {
            if (document.querySelector('#clause-editor-container .ql-editor')) {
                return;
            }
            quill = new Quill('#clause-editor-container', {
                modules: {
                    toolbar: [
                        [{ 'font': [] }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                },
                theme: 'snow'
            });
        }

        window.showTab = (tabName) => {
            document.getElementById('extrator-view').classList.add('hidden');
            document.getElementById('clausulas-view').classList.add('hidden');
            document.getElementById('tab-extrator').classList.remove('active');
            document.getElementById('tab-clausulas').classList.remove('active');
            document.getElementById(`${tabName}-view`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        window.showAlert3s = (message) => {
            const alertBox = document.getElementById('alert-box');
            alertBox.textContent = message || 'A√ß√£o conclu√≠da com sucesso!';
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }

        window.openModal = (modalId) => {
            document.getElementById(modalId).classList.replace('hidden', 'flex');
            if (modalId === 'manage-clause-modal') {
                initializeQuillEditor();
            }
        }

        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.replace('flex', 'hidden');
        }

        // --- L√ìGICA DAS CL√ÅUSULAS ---
        document.getElementById('incluir-clausula-btn').addEventListener('click', () => openModal('password-modal'));
        
        window.checkPassword = () => {
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');
            if (passwordInput.value === '123') {
                passwordInput.value = '';
                passwordError.classList.add('hidden');
                closeModal('password-modal');
                openModal('manage-clause-modal');
            } else {
                passwordError.classList.remove('hidden');
            }
        };

        const renderClauses = (filter = '') => {
            const listContainer = document.getElementById('clausulas-list');
            const manageListContainer = document.getElementById('manage-clausulas-list');
            listContainer.innerHTML = '';
            manageListContainer.innerHTML = '';
            
            const filteredClauses = Object.entries(allClauses).filter(([id, clause]) =>
                clause.title.toLowerCase().includes(filter.toLowerCase())
            ).sort(([, a], [, b]) => a.title.localeCompare(b.title));
            
            if (filteredClauses.length === 0) {
                const emptyMsg = `<div class="text-center text-sm text-gray-500 p-4">Nenhuma cl√°usula encontrada.</div>`;
                listContainer.innerHTML = emptyMsg;
                manageListContainer.innerHTML = emptyMsg;
                return;
            }
            
            filteredClauses.forEach(([id, clause]) => {
                const item = document.createElement('div');
                item.className = 'clausula-item p-3 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700';
                item.textContent = clause.title;
                item.dataset.id = id;
                item.onclick = () => selectClause(id);
                listContainer.appendChild(item);
                
                const manageItem = document.createElement('div');
                manageItem.className = 'flex justify-between items-center p-2 rounded-md bg-gray-100 dark:bg-gray-700';
                manageItem.innerHTML = `<span class="font-medium">${clause.title}</span><div class="flex gap-2"><button onclick="editClause('${id}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button><button onclick="deleteClause('${id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></div>`;
                manageListContainer.appendChild(manageItem);
            });
        }

        window.selectClause = (id) => {
            const clause = allClauses[id];
            if (!clause) return;
            
            document.querySelectorAll('.clausula-item').forEach(el => el.classList.remove('selected'));
            const selectedElement = document.querySelector(`.clausula-item[data-id="${id}"]`);
            if (selectedElement) selectedElement.classList.add('selected');
            
            const viewer = document.getElementById('clausula-viewer');
            viewer.innerHTML = `
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-[var(--card-border)]">
                    <h3 class="text-2xl font-bold">${clause.title}</h3>
                    <div class="flex gap-2">
                        <button onclick="copyClauseContent()" class="botao flex items-center" style="background-color: var(--primary-color);">
                            <i class="fas fa-copy mr-2"></i>Copiar
                        </button>
                        <button onclick="adicionarClausulaAoTexto('${id}')" class="botao flex items-center" style="background-color: var(--secondary-color);">
                            <i class="fas fa-plus mr-2"></i>Adicionar ao Cabe√ßalho
                        </button>
                        <button onclick="adicionarClausulaAoEditor('${id}')" class="botao flex items-center" style="background-color: var(--secondary-color);">
                            <i class="fas fa-plus mr-2"></i>Editar e Adicionar ao Cabe√ßalho
                        </button>
                    </div>
                </div>
                <div id="clause-content-display" class="prose dark:prose-invert max-w-none">${clause.content}</div>
            `;
        };

        document.getElementById('search-clausulas').addEventListener('input', (e) => {
            renderClauses(e.target.value);
        });

        document.getElementById('clause-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('clause-id').value;
            const title = document.getElementById('clause-title').value;
            const content = quill.root.innerHTML;
            
            if (title.trim() === '' || content === '<p><br></p>') {
                showAlert3s('O t√≠tulo e o conte√∫do n√£o podem estar vazios.');
                return;
            }
            
            const clauseData = { title, content };
            try {
                if (id) {
                    await set(ref(db, `clauses/${id}`), clauseData);
                    showAlert3s('Cl√°usula atualizada com sucesso!');
                } else {
                    await push(clausesRef, clauseData);
                    showAlert3s('Cl√°usula criada com sucesso!');
                }
                resetClauseForm();
            } catch (error) {
                console.error("Erro ao salvar cl√°usula: ", error);
                showAlert3s('Erro ao salvar. Tente novamente.');
            }
        });

        window.resetClauseForm = () => {
            document.getElementById('clause-form').reset();
            document.getElementById('clause-id').value = '';
            if (quill) {
                quill.setContents([]);
            }
        }

        window.editClause = (id) => {
            const clause = allClauses[id];
            if (!clause) return;
            
            document.getElementById('clause-id').value = id;
            document.getElementById('clause-title').value = clause.title;
            
            if (quill) {
                quill.clipboard.dangerouslyPasteHTML(clause.content);
            }
        }

        window.deleteClause = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta cl√°usula?')) {
                try {
                    await remove(ref(db, `clauses/${id}`));
                    showAlert3s('Cl√°usula exclu√≠da com sucesso!');
                } catch (error) {
                    console.error("Erro ao excluir: ", error);
                    showAlert3s('Erro ao excluir. Tente novamente.');
                }
            }
        }

        onValue(clausesRef, (snapshot) => {
            allClauses = snapshot.val() || {};
            renderClauses(document.getElementById('search-clausulas').value);
        });

        window.copyClauseContent = () => {
            const contentElement = document.getElementById('clause-content-display');
            if (!contentElement) {
                showAlert3s('Nenhum conte√∫do para copiar.');
                return;
            }
            
            const htmlContent = contentElement.innerHTML;
            const cleanedContent = cleanQuillHtmlForWord(htmlContent);
            const contentToCopy = `<div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt; text-align: justify; margin: 0;">${cleanedContent}</div>`;
            
            const blob = new Blob([contentToCopy], { type: 'text/html' });
            const clipboardItem = new ClipboardItem({ 'text/html': blob });
            
            navigator.clipboard.write([clipboardItem]).then(() => {
                showAlert3s('Conte√∫do da cl√°usula copiado! Lembre-se de alterar a forma de colar no Word para "Manter a formata√ß√£o original"');
            }).catch(err => {
                console.error('Falha ao copiar conte√∫do: ', err);
                showAlert3s('Erro ao copiar o conte√∫do.');
            });
        };

        // --- L√ìGICA DO EXTRATOR DE CABE√áALHOS ---
        window.extrairClipboard = () => {
            navigator.clipboard.readText().then(text => {
                document.getElementById('caixa1').value = text;
                processarCaixas();
            }).catch(err => {
                console.error('Falha ao ler da √°rea de transfer√™ncia: ', err);
                showAlert3s('Erro ao acessar a √°rea de transfer√™ncia.');
            });
        }

        window.limparCaixas = () => {
            for (let i = 1; i <= 7; i++) {
                document.getElementById('caixa' + i).value = '';
            }
            
            if (quillOutput1) quillOutput1.setContents([]);
            if (quillOutput2) quillOutput2.setContents([]);
            if (quillOutput3) quillOutput3.setContents([]);
        }

        const cleanQuillHtmlForWord = (html) => {
            if (!html) return '';
            
            let cleaned = html.replace(/<p\b[^>]*>/g, (match) => {
                if (match.includes('style=')) {
                    return match.replace(/style="([^"]*)"/, (sMatch, p1) => {
                        if (p1.includes('margin:')) {
                            return `style="${p1.replace(/margin: [^;]*;?/g, 'margin: 0;')}"`;
                        }
                        return `style="margin: 0; line-height: 18pt; mso-line-height-alt:18pt; ${p1}"`;
                    });
                }
                return match.replace('<p', '<p style="margin: 0; line-height: 18pt; mso-line-height-alt:18pt;"');
            });

            cleaned = cleaned.replace(/<p\s*style="[^"]*"\s*><br><\/p>/g, '');

            cleaned = cleaned.replace(/<div\b[^>]*>/g, (match) => {
                if (match.includes('style=')) {
                    return match.replace(/style="([^"]*)"/, (sMatch, p1) => {
                        if (p1.includes('margin:')) {
                            return `style="${p1.replace(/margin: [^;]*;?/g, 'margin: 0;')}"`;
                        }
                        return `style="margin: 0; line-height: 18pt; mso-line-height-alt:18pt; ${p1}"`;
                    });
                }
                return match.replace('<div', '<div style="margin: 0; line-height: 18pt; mso-line-height-alt:18pt;"');
            });

            return cleaned;
        };

        // ===================================================================
        // FUN√á√ÉO DE COPIAR CABE√áALHO ATUALIZADA COM ESPA√áAMENTO
        // ===================================================================
        window.copiarDadosFormatados = () => {
            if (!quillOutput1 || !quillOutput2 || !quillOutput3) {
                showAlert3s('Primeiro extraia os dados.');
                return;
            }

            const output1 = getFormattedContentFromQuill(quillOutput1);
            const output2 = getFormattedContentFromQuill(quillOutput2);
            const output3 = getFormattedContentFromQuill(quillOutput3);

            if (!output1 && !output2 && !output3) {
                showAlert3s('N√£o h√° dados para copiar.');
                return;
            }

            const htmlString = `
        <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">
            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 8pt; line-height: 18pt; mso-line-height-alt:18pt;">
                            <p style="text-align: center; margin: 0 0 8pt 0; font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">
                                <strong style="text-decoration: underline;">DADOS EXTRA√çDOS DO PJE</strong>
                            </p>
                            <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">${output1}</div>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>
            
            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 8pt; line-height: 18pt; mso-line-height-alt:18pt;">
                            <p style="text-align: center; margin: 0 0 8pt 0; font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">
                                <strong style="text-decoration: underline;">PARTICIPANTES DA AUDI√äNCIA</strong>
                            </p>
                            <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">${output2}</div>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>
            
            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 8pt; line-height: 18pt; mso-line-height-alt:18pt;">
                            <p style="text-align: center; margin: 0 0 8pt 0; font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">
                                <strong style="text-decoration: underline;">DADOS DAS PARTES</strong><br>
                                <span style="font-size: 10pt; line-height: 18pt; mso-line-height-alt:18pt;">(Portaria Conjunta GPR, GPVP, GSVP e GC n.¬∫ 71/2013; e CPC, art. 319, II)</span>
                            </p>
                            <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">${output3}</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;

            const blob = new Blob([htmlString], { type: 'text/html' });
            const clipboardItem = new ClipboardItem({ 'text/html': blob });

            navigator.clipboard.write([clipboardItem]).then(() => {
                showAlert3s('Cabe√ßalho copiado com sucesso! Lembre-se de alterar a forma de colar no Word para "Manter a formata√ß√£o original"');
            }).catch(err => {
                console.error('Falha ao copiar o cabe√ßalho: ', err);
                showAlert3s('Erro ao copiar o cabe√ßalho.');
            });
        };

        // ===================================================================
        // FUN√á√ÉO ADICIONAR CL√ÅUSULA ATUALIZADA COM ESPA√áAMENTO
        // ===================================================================
        window.adicionarClausulaAoTexto = (id) => {
            const clause = allClauses[id];
            if (!clause) return showAlert3s('Cl√°usula n√£o encontrada.');
            if (!quillOutput1 || !quillOutput2 || !quillOutput3) {
                showAlert3s('Primeiro extraia os dados.');
                return;
            }

            const output1 = getFormattedContentFromQuill(quillOutput1);
            const output2 = getFormattedContentFromQuill(quillOutput2);
            const output3 = getFormattedContentFromQuill(quillOutput3);

            if (!output1 && !output2 && !output3) {
                showAlert3s('Primeiro gere e copie o cabe√ßalho antes de incluir cl√°usulas.');
                return;
            }

            const cabecalhoHTML = `
        <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">
            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 8pt; line-height: 18pt; mso-line-height-alt:18pt;">
                            <p style="text-align: center; margin: 0 0 8pt 0; font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">
                                <strong style="text-decoration: underline;">DADOS EXTRA√çDOS DO PJE</strong>
                            </p>
                            <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">${output1}</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>

            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 8pt; line-height: 18pt; mso-line-height-alt:18pt;">
                            <p style="text-align: center; margin: 0 0 8pt 0; font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">
                                <strong style="text-decoration: underline;">PARTICIPANTES DA AUDI√äNCIA</strong>
                            </p>
                            <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">${output2}</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>

            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 8pt; line-height: 18pt; mso-line-height-alt:18pt;">
                            <p style="text-align: center; margin: 0 0 8pt 0; font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">
                                <strong style="text-decoration: underline;">DADOS DAS PARTES</strong><br>
                                <span style="font-size: 10pt; line-height: 18pt; mso-line-height-alt:18pt;">(Portaria Conjunta GPR, GPVP, GSVP e GC n.¬∫ 71/2013; e CPC, art. 319, II)</span>
                            </p>
                            <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">${output3}</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;

            const agora = new Date();
            const dia = String(agora.getDate()).padStart(2, '0');
            const mes = agora.toLocaleString('pt-BR', { month: 'long' });
            const ano = agora.getFullYear();
            const horas = String(agora.getHours()).padStart(2, '0');

            const paragrafoData = `
        <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>
        <p style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt; text-align: justify; margin: 0;">
          Em ${dia} de ${mes} de ${ano}, √†s ${horas}hXXmin, os participantes acima indicados e qualificados participaram da audi√™ncia virtual no 
           <strong>Centro Judici√°rio de Solu√ß√£o de Conflitos e Cidadania Virtual 3 (e-CEJUSC 3)</strong>, 
           por meio do aplicativo denominado Microsoft TEAMS, observando as regras da Portaria GSVP/TJDFT n¬∫. 81/2016. 
           As partes presentes confirmaram os seus dados pessoais e as pessoas f√≠sicas apresentaram por v√≠deo seus documentos de identifica√ß√£o. 
           Durante a audi√™ncia, as partes concordaram com o seguinte acordo:
        </p>

        <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>
        <p style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt; text-align: justify; margin: 0; color: red;">
           Ou no caso de um acordo parcial
        </p>

        <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>
        <p style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt; text-align: justify; margin: 0;">
            Em ${dia} de ${mes} de ${ano}, √†s ${horas}hXXmin, os participantes acima indicados e qualificados participaram da audi√™ncia virtual no 
            <strong>Centro Judici√°rio de Solu√ß√£o de Conflitos e Cidadania Virtual 3 (e-CEJUSC 3)</strong>, 
            por meio do aplicativo denominado Microsoft TEAMS, observando as regras da Portaria GSVP/TJDFT n¬∫. 81/2016. 
            As partes presentes confirmaram os seus dados pessoais e as pessoas f√≠sicas apresentaram por v√≠deo seus documentos de identifica√ß√£o. Durante a 
            audi√™ncia, <strong>a(s) parte(s) autora(s) e a(s) parte(s) requerida(s) XXXXXXX, de forma livre e espont√¢nea, celebraram o seguinte ACORDO PARCIAL:</strong>
        </p>
    `;

            const clausulaFormatada = `
        <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>
        <div style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt; text-align: justify; margin: 0;">
            ${cleanQuillHtmlForWord(clause.content)}
        </div>
    `;

            const textoFinal = `${cabecalhoHTML}${paragrafoData}${clausulaFormatada}`;

            const blob = new Blob([textoFinal], { type: 'text/html' });
            const clipboardItem = new ClipboardItem({ 'text/html': blob });
            
            navigator.clipboard.write([clipboardItem]).then(() => {
                showAlert3s('Cabe√ßalho + cl√°usula copiados com sucesso! Lembre-se de alterar a forma de colar no Word para "Manter a formata√ß√£o original"');
            }).catch(err => {
                console.error('Erro ao copiar conte√∫do combinado: ', err);
                showAlert3s('Erro ao copiar o conte√∫do combinado.');
            });
        };

        window.processarCaixas = () => {
            initializeOutputEditors();

            const caixa1 = document.getElementById('caixa1').value.split('\n');
            if (caixa1.length > 1) {
                document.getElementById('caixa2').value = caixa1[1].replace(/[^\d\W]/g, '');
            }
            const orgaoJulgadorIndex = caixa1.findIndex(line => line.includes('√ìrg√£o julgador'));
            if (orgaoJulgadorIndex !== -1 && orgaoJulgadorIndex + 1 < caixa1.length) {
                document.getElementById('caixa3').value = caixa1[orgaoJulgadorIndex + 1];
            }
            const poloAtivoIndex = caixa1.findIndex(line => line.includes('Polo ativo'));
            const poloPassivoIndex = caixa1.findIndex(line => line.includes('Polo passivo'));
            if (poloAtivoIndex !== -1 && poloPassivoIndex !== -1 && poloAtivoIndex < poloPassivoIndex) {
                const requerentes = caixa1.slice(poloAtivoIndex + 1, poloPassivoIndex).filter(line => !line.startsWith(' ')).map(line => line.replace('Parte cadastrada no Domicilio Judicial Eletr√¥nico - Resolu√ß√£o CNJ N¬∫ 455 de 27/04/2022 ', '')).filter(line => !line.includes('Procuradoria cadastrada no'));
                document.getElementById('caixa4').value = requerentes.join('\n');
            }
            const iconeDownloadIndex = caixa1.findIndex(line => line.includes('√çcone de download'));
            if (poloPassivoIndex !== -1 && iconeDownloadIndex !== -1 && iconeDownloadIndex > poloPassivoIndex) {
                const requeridos = caixa1.slice(poloPassivoIndex + 1, iconeDownloadIndex).filter(line => /(REQUERIDO|R√âU|REU|EXECUTADO|EMBARGado)\)$/.test(line.trim())).map(line => line.replace('Parte cadastrada no Domicilio Judicial Eletr√¥nico - Resolu√ß√£o CNJ N¬∫ 455 de 27/04/2022 ', ''));
                document.getElementById('caixa6').value = requeridos.join('\n');
            }
            document.getElementById('caixa5').value = formatarRequerentes(document.getElementById('caixa4').value.split('\n'));
            document.getElementById('caixa7').value = formatarRequeridos(document.getElementById('caixa6').value.split('\n'));
            atualizarOutputs();
        }

        const formatarRequerentes = (requerentes) => {
            if (requerentes.length === 1) {
                return `<b>Requerente:</b> ${requerentes[0].replace(/ \((REQUERENTE|AUTOR|EXEQUENTE|AUTORA|EMBARGANTE)\)/g, '')}`;
            }
            return requerentes.map((req, index) => `<b>${index + 1}¬∫ Requerente:</b> ${req.replace(/ \((REQUERENTE|AUTOR|EXEQUENTE|AUTORA|EMBARGANTE)\)/g, '')}`).join('\n');
        }

        const formatarRequeridos = (requeridos) => {
            if (requeridos.length === 1) {
                return `<b>Requerido(a):</b> ${requeridos[0].replace(/ \((REQUERIDO|R√âU|REU|EXECUTADO|EMBARGADO)\)/g, '')}`;
            }
            return requeridos.map((req, index) => `<b>${index + 1}¬∫ Requerido(a):</b> ${req.replace(/ \((REQUERIDO|R√âU|REU|EXECUTADO|EMBARGADO)\)/g, '')}`).join('\n');
        }

        const atualizarOutputs = () => {
            const caixa4 = document.getElementById('caixa4').value.split('\n');
            const caixa6 = document.getElementById('caixa6').value.split('\n');
            const hasExequente = caixa4.some(line => /\(EXEQUENTE\)$/.test(line.trim()));
            const hasExecutado = caixa6.some(line => /\(EXECUTADO\)$/.test(line.trim()));
            const hasEmbargante = caixa4.some(line => /\(EMBARGANTE\)$/.test(line.trim()));
            const hasEmbargado = caixa6.some(line => /\(EMBARGADO\)$/.test(line.trim()));
            const exequenteTermo = hasExequente ? 'Exequente' : hasEmbargante ? 'Embargante' : 'Requerente';
            const executadoTermo = hasExecutado ? 'Executado(a)' : hasEmbargado ? 'Embargado(a)' : 'Requerido(a)';
            const exequenteParte = hasExequente ? 'EXEQUENTE' : hasEmbargante ? 'EMBARGANTE' : 'REQUERENTE';
            const executadoParte = hasExecutado ? 'EXECUTADA' : hasEmbargado ? 'EMBARGADA' : 'REQUERIDA';
            const caixa8 = `<b>Ju√≠zo:</b> ${document.getElementById('caixa3').value}\n` +
                `<b>Processo:</b> ${document.getElementById('caixa2').value}\n` +
                `${document.getElementById('caixa5').value.replace(/Requerente:/g, `${exequenteTermo}:`)}\n` +
                `${document.getElementById('caixa7').value.replace(/Requerido\(a\):/g, `${executadoTermo}:`)}`;

            const caixa9 = caixa8.split('\n').slice(2).map(line => `${line.trim()}<br><b>Telefone:</b> N√∫mero<br><b>Preposto(a):</b> nome completo, <b>CPF:</b> n√∫mero, <b>telefone:</b> n√∫mero (<b>Carta de preposto ID n. xxxx</b>).<br><b>Advogado(a):</b> nome completo, <b>OAB/DF:</b> n√∫mero, <b>telefone:</b> n√∫mero (<b>Procura√ß√£o ID xxxx</b>).<br><br>`).join('').replace(/^\s+/gm, '');

            const textoAdicional = `<b>Observador(es):</b> Nome completo, CPF, (...), que assume(m) o dever de confidencialidade (CPC, art. 166, ¬ß 1¬∫).<br><br><b>Conciliador(es)/Mediador(es):</b> Nome completo &emsp; <b>Sala:</b> n√∫mero da sala<br><br><b>Supervisor(es):</b> Nome se houver e <b>Matr√≠cula:</b> n√∫mero`;
            const formatBold = text => text.replace(/(CPF:|CNPJ:)/g, '<b>$1</b>');

            const requerentes = caixa4.map(req => req.replace(/ \((REQUERENTE|AUTOR|EXEQUENTE|AUTORA|EMBARGANTE)\)/g, '').trim());
            const requeridos = caixa6.map(req => req.replace(/ \((REQUERIDO|R√âU|REU|EXECUTADO|EMBARGADO)\)/g, '').trim());
            let output3Content = '';
            requerentes.forEach((req, index) => {
                const prefix = requerentes.length > 1 ? `A parte ${index + 1}¬™ ${exequenteParte}` : `A parte ${exequenteParte}`;
                const type = req.includes('CNPJ:') ? 'pessoa jur√≠dica estabelecida no(a)' : 'residente e domiciliado(a)';
                output3Content += `<p style="margin: 0; line-height: 18pt; mso-line-height-alt:18pt;"><b>${prefix}: ${req}</b>, ${type} xxxx, telefone xxxx e e-mail xxxx.</p>`;
            });
            requeridos.forEach((req, index) => {
                const prefix = requeridos.length > 1 ? `A parte ${index + 1}¬™ ${executadoParte}` : `A parte ${executadoParte}`;
                const type = req.includes('CNPJ:') ? 'pessoa jur√≠dica estabelecida no(a)' : 'residente e domiciliado(a)';
                output3Content += `<p style="margin: 0; line-height: 18pt; mso-line-height-alt:18pt;"><b>${prefix}: ${req}</b>, ${type} xxxx, telefone xxxx e e-mail xxxx.</p>`;
            });

            quillOutput1.clipboard.dangerouslyPasteHTML(0, formatBold(caixa8).replace(/\n/g, '<br>'));
            quillOutput2.clipboard.dangerouslyPasteHTML(0, formatBold(caixa9 + textoAdicional));
            quillOutput3.clipboard.dangerouslyPasteHTML(0, output3Content);

            [quillOutput1, quillOutput2, quillOutput3].forEach(q => {
                q.root.style.fontFamily = 'Arial, sans-serif';
                q.root.style.fontSize = '12pt';
                q.root.style.lineHeight = '18pt';
                q.update('user');
            });
        }

        window.gerarWord = () => {
            if (!quillOutput1 || !quillOutput2 || !quillOutput3) {
                showAlert3s('Primeiro extraia os dados.');
                return;
            }

            const output1 = getFormattedContentFromQuill(quillOutput1);
            const output2 = getFormattedContentFromQuill(quillOutput2);
            const output3 = getFormattedContentFromQuill(quillOutput3);

            const content = `<html xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><style>@page WordSection1 { size: 595.3pt 841.9pt; margin: 2cm; } div.WordSection1 { page: WordSection1; } body { font-family: Arial, sans-serif; font-size: 12pt; color: black; text-align: justify; line-height: 18pt; mso-line-height-alt:18pt; } table { width: 100%; border-collapse: collapse; margin-bottom: 20px; } table, td { border: 1px solid black; } td { padding: 10px; } p { line-height: 18pt; mso-line-height-alt:18pt; margin: 0; } .titulo { text-align: center; font-weight: bold; text-decoration: underline; margin-bottom: 10px; }</style></head><body><div class="WordSection1"><p style="text-align:center; font-weight:bold;">TERMO DE SESS√ÉO DE CONCILIA√á√ÉO ‚Äì JUIZADO ESPECIAL C√çVEL</p><p style="text-align:center; font-weight:bold;">(____________)</p><table><tr><td><p class="titulo">DADOS EXTRA√çDOS DO PJE</p>${output1}</td></tr></table><p>&nbsp;</p><table><tr><td><p class="titulo">PARTICIPANTES DA AUDI√äNCIA</p>${output2}</td></tr></table><p>&nbsp;</p><table><tr><td><p class="titulo">DADOS DAS PARTES</p><p style="text-align:center;">(Portaria Conjunta GPR, GPVP, GSVP e GC n.¬∫ 71/2013; e CPC, art. 319, II))</p>${output3}</td></tr></table></div></body></html>`;
            const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const nomeArquivo = document.getElementById('caixa2').value.trim().replace(/^_/, '');
            link.href = url;
            link.download = `${nomeArquivo || 'documento'} - CABE√áALHO.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- TEMA CLARO/ESCURO ---
        const themeToggle = document.getElementById("theme-toggle");
        const themeIcon = document.getElementById("theme-icon");
        const body = document.body;
        const savedTheme = localStorage.getItem("theme") || "light";
        body.classList.toggle("dark", savedTheme === "dark");
        themeIcon.className = savedTheme === "dark" ? "fas fa-sun" : "fas fa-moon";
        themeToggle.addEventListener("change", () => {
            const isDark = body.classList.toggle("dark");
            themeIcon.className = isDark ? "fas fa-sun" : "fas fa-moon";
            localStorage.setItem("theme", isDark ? "dark" : "light");
        });

        // ===================================================================
        // ADICIONAR CL√ÅUSULA AO EDITOR
        // ===================================================================
        window.adicionarClausulaAoEditor = (id) => {
            const clause = allClauses[id];
            if (!clause) return showAlert3s('Cl√°usula n√£o encontrada.');

            const output1 = getFormattedContentFromQuill(quillOutput1);
            const output2 = getFormattedContentFromQuill(quillOutput2);
            const output3 = getFormattedContentFromQuill(quillOutput3);

            if (!output1 && !output2 && !output3) {
                showAlert3s('Primeiro gere o cabe√ßalho antes de adicionar cl√°usulas.');
                return;
            }

            const agora = new Date();
            const dia = String(agora.getDate()).padStart(2, '0');
            const mes = agora.toLocaleString('pt-BR', { month: 'long' });
            const ano = agora.getFullYear();
            const horas = String(agora.getHours()).padStart(2, '0');

            const paragrafoData = `
        <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>
        <p style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt; text-align: justify; margin: 0;">
            Em ${dia} de ${mes} de ${ano}, √†s ${horas}hXXmin, os participantes acima indicados e qualificados participaram da audi√™ncia virtual no 
            <strong>Centro Judici√°rio de Solu√ß√£o de Conflitos e Cidadania Virtual 3 (e-CEJUSC 3)</strong>, 
            por meio do aplicativo denominado Microsoft TEAMS, observando as regras da Portaria GSVP/TJDFT n¬∫. 81/2016. 
            As partes presentes confirmaram os seus dados pessoais e as pessoas f√≠sicas apresentaram por v√≠deo seus documentos de identifica√ß√£o. 
            Durante a audi√™ncia, as partes concordaram com o seguinte acordo:
        </p>

        <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>
        <p style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt; text-align: justify; margin: 0; color: red;">
            <strong>Ou no caso de um acordo parcial </strong>
        </p>

        <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>
        <p style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt; text-align: justify; margin: 0;">
            Em ${dia} de ${mes} de ${ano}, √†s ${horas}hXXmin, os participantes acima indicados e qualificados participaram da audi√™ncia virtual no 
            <strong>Centro Judici√°rio de Solu√ß√£o de Conflitos e Cidadania Virtual 3 (e-CEJUSC 3)</strong>, 
            por meio do aplicativo denominado Microsoft TEAMS, observando as regras da Portaria GSVP/TJDFT n¬∫. 81/2016. 
            As partes presentes confirmaram os seus dados pessoais e as pessoas f√≠sicas apresentaram por v√≠deo seus documentos de identifica√ß√£o. Durante a 
            audi√™ncia, <strong>a(s) parte(s) autora(s) e a(s) parte(s) requerida(s) XXXXXXX, de forma livre e espont√¢nea, celebraram o seguinte ACORDO PARCIAL:</strong>
        </p>
    `;

            const clausulaHTML = `
        <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>
        <div style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt; text-align: justify; margin: 0;">
            ${clause.content}
        </div>
    `;

            const conteudoEditavel = `${paragrafoData}${clausulaHTML}`;

            openModal('edit-before-copy-modal');

            if (!quillEditCopy) {
                quillEditCopy = new Quill('#edit-copy-container', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'font': [] }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                            [{ 'align': [] }],
                            ['clean']
                        ]
                    }
                });
            } else {
                quillEditCopy.setContents([]);
            }

            quillEditCopy.clipboard.dangerouslyPasteHTML(conteudoEditavel);

            setTimeout(() => {
                const editorEl = document.querySelector('#edit-copy-container .ql-editor');
                if (editorEl) editorEl.focus();
            }, 200);
        };

        // ===================================================================
        // COPIAR CONTE√öDO EDITADO COM ESPA√áAMENTO
        // ===================================================================
        window.copiarTextoEditado = () => {
            if (!quillEditCopy) return;
            if (!quillOutput1 || !quillOutput2 || !quillOutput3) {
                showAlert3s('Primeiro extraia os dados.');
                return;
            }

            const conteudoEditado = cleanQuillHtmlForWord(quillEditCopy.root.innerHTML);

            const output1 = getFormattedContentFromQuill(quillOutput1);
            const output2 = getFormattedContentFromQuill(quillOutput2);
            const output3 = getFormattedContentFromQuill(quillOutput3);

            const cabecalhoHTML = `
        <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt; color: black;">
            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 8pt; line-height: 18pt; mso-line-height-alt:18pt;">
                            <p style="text-align: center; font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;"><strong style="text-decoration: underline;">DADOS EXTRA√çDOS DO PJE</strong></p>
                            <div style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">${output1}</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>

            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 8pt; line-height: 18pt; mso-line-height-alt:18pt;">
                            <p style="text-align: center; font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;"><strong style="text-decoration: underline;">PARTICIPANTES DA AUDI√äNCIA</strong></p>
                            <div style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">${output2}</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0; line-height: 18pt; mso-line-height-alt:18pt;">&nbsp;</p>

            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 8pt; line-height: 18pt; mso-line-height-alt:18pt;">
                            <p style="text-align: center; font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">
                                <strong style="text-decoration: underline;">DADOS DAS PARTES</strong><br>
                                <span style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">(Portaria Conjunta GPR, GPVP, GSVP e GC n.¬∫
                                        71/2013; e CPC, art. 319, II)</span>
                            </p>
                            <div style="font-family: Arial; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt;">${output3}</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;

            const textoFinal = `
        <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt; mso-line-height-alt:18pt; text-align: justify; margin: 0;">
            ${cabecalhoHTML}
            ${conteudoEditado}
        </div>
    `;

            const blob = new Blob([textoFinal], { type: 'text/html' });
            const clipboardItem = new ClipboardItem({ 'text/html': blob });

            navigator.clipboard.write([clipboardItem])
                .then(() => showAlert3s('Cabe√ßalho + cl√°usula (editada) copiados com formata√ß√£o preservada!'))
                .catch(err => {
                    console.error('Erro ao copiar conte√∫do editado:', err);
                    showAlert3s('Erro ao copiar conte√∫do editado.');
                });
        };

        // ===================================================================
        // COPIAR SOMENTE TEXTO EDITADO COM ESPA√áAMENTO
        // ===================================================================
        window.copiarSomenteTextoEditado = () => {
            if (!quillEditCopy) return;

            const conteudoEditado = cleanQuillHtmlForWord(quillEditCopy.root.innerHTML);

            const textoFormatado = `
        <div style="font-family: Arial, sans-serif; font-size: 12pt; text-align: justify; line-height: 18pt; mso-line-height-alt:18pt; margin: 0;">
            ${conteudoEditado}
        </div>
    `;

            const blob = new Blob([textoFormatado], { type: 'text/html' });
            const clipboardItem = new ClipboardItem({ 'text/html': blob });

            navigator.clipboard.write([clipboardItem])
                .then(() => showAlert3s('Cl√°usula e par√°grafos copiados com formata√ß√£o preservada!'))
                .catch(err => {
                    console.error('Erro ao copiar apenas o texto:', err);
                    showAlert3s('Erro ao copiar o texto.');
                });
        };

        // Inicializa os editores de output na carga da p√°gina
        initializeOutputEditors();
    </script>
</body>
</html>
